---
title: "Invasive_wrack_manuscript_code"
author: "Ric DeSantiago"
date: "12/15/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---
#libraries
```{r libraries}
library(knitr)
library(tidyverse)
library(tidyr)
library(ggplot2)
library(ggfortify)
library(lme4)
library(car)
library(nlme)
library(ggpubr)
library(multcompView)
library(boot)
library(Hotelling)
library(mvnTest)
library(vegan)
library(factoextra)
library(FactoMineR)
library(agricolae)
library(glmm)
library(HH)
library(ggpubr)
library(rstatix)

#hi
```


#Load Field Surveys
```{r}

wrack<-read.csv("InvasiveWrackSurveySNIJan2020.csv", header = TRUE)
view(wrack)
Grazer_Survey_Data <- read.csv("GrzrOnOffSurveySNIJan2020.csv") 
view(Grazer_Survey_Data)

```

##Wrack surveys
```{r}
#make a new column in datasheet for the proportion of total wrack patty area made up of sargassum
wrack$propsarg <- wrack$sarg_total / wrack$ellipse_A_m2

#make new column to show proportion of total made up of macrocystis (1-sargassum)
wrack$propmac<- 1 - wrack$propsarg

#make graph to show these proportions
ggplot(data=wrack, aes(x=site, y=propmac, fill=propsarg)) +
  geom_bar(stat="identity")

```

##Invasive Wrack usage survey
```{r}
Grazer_Survey_Data <- read.csv("GrzrOnOffSurveySNIJan2020.csv") 

#we want to remove any row that has double 0's, so a 0 for on and a 0 for off, this is because not every recorder recorded 0's when animals weren't seen. Therefore, by keeping double 0's in, we're inflating the likelihood of not finding an animal

Grazer_Survey_Data_edited <- Grazer_Survey_Data 
Grazer_Survey_Data_edited<- mutate(Grazer_Survey_Data_edited, Grazer_sum = on_wrack + off_wrack) 
filter(Grazer_Survey_Data_edited, Grazer_sum != 0)
#this removed 13 observations

#create a dataframe with just important columns
Grazer_Survey_Data_reduced <- na.omit(Grazer_Survey_Data_edited[, -c(1:3, 5, 7)])

#Change to long format
Grazer_Survey_Data_long <- gather(data = Grazer_Survey_Data_reduced, 
                                 key = "Wrack.Use", value = "Grazer_sum", c(on_wrack, off_wrack), factor_key = TRUE)

#Barplot
barplot<- ggplot(Grazer_Survey_Data_long, aes(fill=Wrack.Use, y=Grazer_sum, x=grzr_sp)) + 
    geom_bar(position="dodge", stat="identity")

barplot


pdf(file = "On.off_grazersurvey_Jan2020SanNic.pdf", width = 6, height = 4, useDingbats=F)

Plot_Bar_g <- ggplot(data=meanAbundance_grazer,
                      aes(y=mean_Abundance, 
                          x=grzr_sp, 
                          fill = Wrack.Use)) +
  geom_bar(stat = "identity", colour = "black", 
           position = position_dodge(width = 0.9))

Plot_Bar_g + theme(axis.title.x = element_text(face="bold",
                                                 size=22),
                           axis.text.x  = element_text(size=20)) + 
  xlab("Grazer") +
  theme(axis.title.y = element_blank()) + 
  ylab("Count (max 20)") +
  theme(axis.title.y = element_text(angle=90, 
                                    face="bold", 
                                    size=22, 
                                    vjust=1.5),
        axis.text.y  = element_text(size=20)) +
  geom_errorbar(aes(ymin=mean_Abundance - SE, 
                    ymax=mean_Abundance + SE), width = 0.05,
                position=position_dodge(width = 0.9)) +
  scale_fill_manual(name = "Wrack usage",
                    values = c("#999999", "#009E73")) +
  theme(legend.justification=c(.5,.5), legend.position=c(.18,.88)) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0)),
                     breaks = pretty(c(0,20), n = 5), 
                     limits = c(0,20))

dev.off()

#let's extract the sample sizes for each of the grazers bc we didn't see grazers everytime

Grazer_Survey_Data_reduced %>% 
  count(grzr_sp)

```


#Choice Assays
```{r}
#import and name data
LabAssayWholeTissue <-read.csv("LabAssaysWholeTissue.csv",header=T)
View(LabAssayWholeTissue)

#ensure factors are correctly read
is.numeric(LabAssayWholeTissue$algae_Wd)
is.factor(LabAssayWholeTissue$algae_spp.)


AllSpeciesWholeTissue<-ggplot(LabAssayWholeTissue, aes(x=grazer_spp., y=algae_Wd, fill= algae_spp.)) + geom_boxplot() + theme_bw()   + xlab("Algae Species") + ylab("Total Consumed (g)") + ggtitle("Live algae choice assay") + theme(plot.title =element_text(hjust = 0.5))
AllSpeciesWholeTissue
```

##Tegula

```{r}
#read and rename file
WholeTissueAssay <- read.csv("LabAssaysWholeTissue.csv",header=T)
View(WholeTissueAssay)

#subset the tegula rows
tegula<-subset(LabAssayWholeTissue, grazer_spp.== "Tegula")
view(tegula)

#since controls were solely used for correction of autogenic growth, we can further subset to only look at the experimental treatments
tegulachoice <- subset(tegula, trt == "exp")
view(tegulachoice)

#visualize data

#look at the data in boxplots to visualize the spread around the median
ggplot(tegulachoice, aes(x=algae_spp., y=algae_Wd)) + geom_boxplot()
#there seems to be an outlier in each treatment that may be pulling distributions, however, we are leaving outliers in as they are biological real, some animals may simply eat more than others.

#separate the histogram by species of algae to visually determine if the distributions of differences (f-i, adjusted for autogenic growth) look normal
#sargassum
tegulachoicesarg<-subset(tegulachoice, algae_spp. == "sargassum")
ggplot(tegulachoicesarg, aes(x=algae_Wd)) + geom_histogram(binwidth=0.1)
mean(tegula$algae_Wd[tegula$algae_spp.== 'sargassum'],na.rm = T)
sd(tegula$algae_Wd[tegula$algae_spp.== 'sargassum'],na.rm = T)
#macrocystis
tegulachoicemacro<-subset(tegulachoice, algae_spp. == "macro")
ggplot(tegulachoicemacro, aes(x=algae_Wd)) + geom_histogram(binwidth=0.1)
mean(tegula$algae_Wd[tegula$algae_spp.== 'macro'],na.rm = T)
sd(tegula$algae_Wd[tegula$algae_spp.== 'macro'],na.rm = T)

#the data do not look normal for the samples, Ds of weight in sargassum tend to be right leaning while macro samples tend to be left learning
#test for normality
par(mfrow=c(2,2))
qqnorm(tegulachoicemacro$algae_Wd)
qqline(tegulachoicemacro$algae_Wd)
qqnorm(tegulachoicesarg$algae_Wd)
qqline(tegulachoicesarg$algae_Wd)

#our data fail the normality assumption for a T-test
##our data are not independent since they are a choice between two options of algae
### To address the question "Do grazers show a preference between S. horneri or M. pyrifera?" we will use consumption as a proxy for choice. Thus, we can use a paired T test to see if there is a difference in "total consumed" between S. horneri and M. pyrifera.
####Paired t-tests are essentially one-sample t-tests, but you are comparing a distribution of DIFFERENCES to a theoretical one rather than a distribution of sample statistics. Thus, the original data are not used, rather the mean, variance, and standard deviation are based on the DIFFERENCES. Thus, we don't need equal variances, only normal distribution of means and equal sample size. 

#check for normality
ggplot(tegulachoice, aes(x=algae_Wd)) + geom_histogram(binwidth=0.1)
qqnorm(tegulachoice$algae_Wd)
qqline(tegulachoice$algae_Wd)
#there seems to be an outlier, however, the data look normally distributed around the theoretical line

#we will conduct a paired-T test.
## H0: There is no difference in total consumed between S. horneri and M. pyrifera  (i.e. there is no choice between algae).
## HA: There is a difference in total consumed between S. horneri and M. pyrifera  (i.e. there is a choice between algae).

#T test
t.test(tegulachoice$algae_Wd~tegulachoice$algae_spp., paired= TRUE)
## we reject the null hypothesis (t = 5.7152, df = 13, p-value = 7.111e-05), there was a choice made between algae


#make boxplot 
ggplot(tegula, aes(x=algae_spp., y=algae_Wd, fill= algae_spp.))+ geom_boxplot() + theme_bw()  + guides() + xlab("Algae Species") + ylab(" Consumtion (g)") + ggtitle("M. pyrifera vs. S. horneri whole tissue consumption by T. funebralis") + theme(plot.title =element_text(hjust = 0.5)) 

#When given a choice between S. horneri and M. pyrifera, Tegula preferred M. pyrifera.

##this will be repeated for all other grazers.

```


##Pachy
```{r}
#subset the P. crassipes rows
pachy<-subset(LabAssayWholeTissue, grazer_spp.== "Pachy")
view(pachy)

#since controls were solely used for correction of autogenic growth, we can further subset to only look at the experimental treatments
pachychoice <- subset(pachy, trt == "exp")
view(pachychoice)

#visualize data

#look at the data in boxplots to visualize the spread around the median
ggplot(pachychoice, aes(x=algae_spp., y=algae_Wd)) + geom_boxplot()
#there seems to be an outlier in the S. horneri treatment that may be pulling the distribution

##due to failed assumptions for T-sample t test (See lines 180+), we will test the nomrality by looking at the distribution of the differences and conduct a Paired T test

#check for normality
ggplot(pachychoice, aes(x=algae_Wd)) + geom_histogram(binwidth=0.1)
qqnorm(pachychoice$algae_Wd)
qqline(pachychoice$algae_Wd)
#there seems to be an outlier, however, the data look normally distributed around the theoretical line

#we will conduct a paired-T test.
## H0: There is no difference in total consumed between S. horneri and M. pyrifera  (i.e. there is no choice between algae).
## HA: There is a difference in total consumed between S. horneri and M. pyrifera  (i.e. there is a choice between algae).

#T test
t.test(pachychoice$algae_Wd~pachychoice$algae_spp., paired= TRUE)
## we fail reject the null hypothesis (t = 0.073928, df = 13, p-value = 0.9422), there was no choice made between algae


#make boxplot 
ggplot(pachy, aes(x=algae_spp., y=algae_Wd, fill= algae_spp.))+ geom_boxplot() + theme_bw()  + guides() + xlab("Algae Species") + ylab(" Consumtion (g)") + ggtitle("M. pyrifera vs. S. horneri whole tissue consumption by P. crassipes ") + theme(plot.title =element_text(hjust = 0.5)) 

#When given a choice between S. horneri and M. pyrifera, P. Crassipes showed no preference.
```

##Pagurus
```{r}

#subset the P. samuelis rows
pagurus<-subset(LabAssayWholeTissue, grazer_spp.== "Pagurus")
view(pagurus)

#since controls were solely used for correction of autogenic growth, we can further subset to only look at the experimental treatments
paguruschoice <- subset(pagurus, trt == "exp")
view(paguruschoice)

#visualize data

#look at the data in boxplots to visualize the spread around the median
ggplot(paguruschoice, aes(x=algae_spp., y=algae_Wd)) + geom_boxplot()

##due to failed assumptions for T-sample t test (See lines 180+), we will test the nomrality by looking at the distribution of the differences and conduct a Paired T test

#check for normality
ggplot(paguruschoice, aes(x=algae_Wd)) + geom_histogram(binwidth=0.1)
qqnorm(paguruschoice$algae_Wd)
qqline(paguruschoice$algae_Wd)
#there seems to be an outlier on both ends, however, the data look normally distributed around the theoretical line

#we will conduct a paired-T test.
## H0: There is no difference in total consumed between S. horneri and M. pyrifera  (i.e. there is no choice between algae).
## HA: There is a difference in total consumed between S. horneri and M. pyrifera  (i.e. there is a choice between algae).

#T test
t.test(paguruschoice$algae_Wd~paguruschoice$algae_spp., paired= TRUE)
## we reject the null hypothesis (t = -3.7593, df = 13, p-value = 0.002385), there was a choice made between algae


#make boxplot 
ggplot(pagurus, aes(x=algae_spp., y=algae_Wd, fill= algae_spp.))+ geom_boxplot() + theme_bw()  + guides() + xlab("Algae Species") + ylab(" Consumtion (g)") + ggtitle("M. pyrifera vs. S. horneri whole tissue consumption by P. samuelis ") + theme(plot.title =element_text(hjust = 0.5)) 

#When given a choice between S. horneri and M. pyrifera, P. samuelis showed a preference for sargassum .
```

##Abalone September 2019
```{r}

#subset the A. cracherodii rows
abalone<-subset(LabAssayWholeTissue, grazer_spp.== "Haliotis cracherodii")
view(abalone)

#since controls were solely used for correction of autogenic growth, we can further subset to only look at the experimental treatments
abalonechoice <- subset(abalone, trt == "Experimental")
view(abalonechoice)

#visualize data

#look at the data in boxplots to visualize the spread around the median
ggplot(abalonechoice, aes(x=algae_spp., y=algae_Wd)) + geom_boxplot()

##due to failed assumptions for T-sample t test (See lines 180+), we will test the nomrality by looking at the distribution of the differences and conduct a Paired T test

#check for normality
ggplot(abalonechoice, aes(x=algae_Wd)) + geom_histogram(binwidth=0.5)
qqnorm(abalonechoice$algae_Wd)
qqline(abalonechoice$algae_Wd)
#the data seem pretty normal

#we will conduct a paired-T test.
## H0: There is no difference in total consumed between S. horneri and M. pyrifera  (i.e. there is no choice between algae).
## HA: There is a difference in total consumed between S. horneri and M. pyrifera  (i.e. there is a choice between algae).

#T test
t.test(abalonechoice$algae_Wd~abalonechoice$algae_spp., paired= TRUE)
## we reject the null hypothesis (4.5053, df = 15, p-value = 0.0004189), there was a choice made between algae


#make boxplot 
ggplot(abalonechoice, aes(x=algae_spp., y=algae_Wd, fill= algae_spp.))+ geom_boxplot() + theme_bw()  + guides() + xlab("Algae Species") + ylab(" Consumtion (g)") + ggtitle("M. pyrifera vs. S. horneri whole tissue consumption by H. cracherodii ") + theme(plot.title =element_text(hjust = 0.5)) 

#When given a choice between S. horneri and M. pyrifera, H. cracherodii showed a preference for M. pyriferae.

```



#Performance Assays March-April 2020
```{r}
#load data
performance<-read.csv("PerformanceAssays2020.csv", header=TRUE)
view(performance)
na.omit(performance)

is.numeric(performance$wetmass_total_Wd)
performance$wetmass_total_Wd<-as.numeric(performance$wetmass_total_Wd)
is.factor(performance$treatment)
performance$treatment<-as.factor(performance$treatment)


#create new column to look at weight difference (Wf-Wi) as a percent of initial weight (Wd/Wi *100) to visualize rough weight differences
performance<-mutate(performance, percent_change = performance$wetmass_total_Wd / performance$wetmass_i* 100)
view(performance)

```


##Red Abalone
###Exploring Data
```{r}

#subset data for abalone
redabaloneperformance<-subset(performance, grazer_spp.== "red abalone")
view(redabaloneperformance)

#visualize data
ggplot(redabaloneperformance, aes(y=terminal_dry_tissue_mass, x=diet)) + geom_boxplot()
#histogram
ggplot(redabaloneperformance, aes(x=terminal_dry_tissue_mass)) + geom_histogram(binwidth=0.1)
#the data look fairly normal when combined, the histogram shows the distribution tailes to the left having some numbers in the negative, this is likely due to the starved treatment.
##we will conduct ANOVA or GLMM if assumptions are met. Starved treatment is used as a control and to detect if any food treatment is worse than starvation (e.g., toxic and harmful algae), thus, starved treatments will not be used unless a food treatment causes more mass loss than starved. 

#explore the data 

#make boxplot for initial wet mass
ggplot(redabaloneperformance, aes(x=diet, y=wetmass_i , fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("H. rufescens Wet Mass (g)") + ggtitle("H. rufescens initial wet mass") + theme(plot.title =element_text(hjust = 0.5))

#make boxplot of final wet mass
ggplot(redabaloneperformance, aes(x=diet, y=wetmass_f , fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("H. rufescens Wet Mass (g)") + ggtitle("H. rufescens final wet mass by diet") + theme(plot.title =element_text(hjust = 0.5))

#make boxplot for mass difference
ggplot(redabaloneperformance, aes(x=diet, y=wetmass_total_Wd , fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("H. rufescens change in wet Mass (g)") + ggtitle("H. rufescens mass change by diet") + theme(plot.title =element_text(hjust = 0.5))
#aside from the variabilty in weights due to water, starved treatment has a mean below zero while others are above 


#look at DRY mass based on tissue type

#make boxplot of final dry mass
ggplot(redabaloneperformance, aes(x=diet, y=terminal_dry_tissue_mass , fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("H. rufescens Dry Mass (g)") + ggtitle("H. rufescens final wet dry by diet") + theme(plot.title =element_text(hjust = 0.5))

#make boxplot of final gonad/gill/digestive dry mass by diet
ggplot(redabaloneperformance, aes(x=diet, y=terminal_gonad_dry_mass, fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("Gonad Dry Mass (g)") + ggtitle("H. rufescens final gonad/gill/GI mass by diet") + theme(plot.title =element_text(hjust = 0.5))

#make boxplot of final foot dry mass by diet
ggplot(redabaloneperformance, aes(x=diet, y=terminal_nongonad_dry_mass, fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("Tissue Dry Mass (g)") + ggtitle("H. rufescens final non-gonad dry mass by diet") + theme(plot.title =element_text(hjust = 0.5))

#make boxplot of final shell dry mass by diet
ggplot(redabaloneperformance, aes(x=diet, y=terminal_shell_dry_mass , fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("Shell Dry Mass (g)") + ggtitle("H. rufescens final shell dry mass by diet") + theme(plot.title =element_text(hjust = 0.5))
```

###Estimating Initial Masses
```{r}

#test if there is a significant difference in initial wet masses using a simple anova
initialmassabs<-aov(redabaloneperformance$wetmass_i ~ redabaloneperformance$diet)
summary(initialmassabs)
#we fail to reject the null hypothesis (p = 0.24), the treatments are not different

##To reduce variance due to water weight, we estimated initial DRY masses through regression analysis using shell lengths to predict dry weight using a sub-sample of the population before the experiment

#read and rename file
regressions <- read.csv("regressiondata.csv",header=T)
View(regressions)

#subset abalone
regressionsub<-subset(regressions, Species == "Ab")

#explore data
mean(regressionsub$Dissected_total_dry_weight)
sd(regressionsub$Dissected_total_dry_weight)
hist(regressionsub$Dissected_total_dry_weight)
mean(regressionsub$Shell_L)
sd(regressionsub$Shell_L)
hist(regressionsub$Shell_L)

#simple scatterplot and pearson correlation
plot(regressionsub$Dissected_total_dry_weight, regressionsub$Shell_L, data = regressionsub, main = "scatterplot")
cor(regressionsub$Dissected_total_dry_weight, regressionsub$Shell_L)

#Abalone models 

#model 1
#regression to predict total dry mass from shell length
mod<-lm(Dissected_total_dry_weight ~ Shell_L, data = regressionsub)
summary(mod)
attributes(mod)

#add the line
abregplot<- plot(regressionsub$Shell_L, regressionsub$Dissected_total_dry_weight, main = "regression",
     xlab = "Shell Length", ylab = "Total Dry Tissue",
     pch = 19, frame = FALSE) +
abline(lm(regressionsub$Dissected_total_dry_weight ~ regressionsub$Shell_L)) 
#Model 1: Total sum of dry tissue     Formula y= 0.56064x -22.41711


#model 2
#regression to predict foot dry tissue mass from shell length
mod2<-lm(Dissected_nongonad_dry_weight ~ Shell_L, data = regressionsub)
summary(mod2)
attributes(mod2)

#add the line
abregplot2<- plot(regressionsub$Shell_L, regressionsub$Dissected_nongonad_dry_weight, main = "regression",
     xlab = "Shell Length", ylab = "Foot Dry Tissue",
     pch = 19, frame = FALSE) +
abline(lm(regressionsub$Dissected_nongonad_dry_weight ~ regressionsub$Shell_L)) 
#Model 2: Foot dry tissue               Formal y= 0.10928x - 4.64417


#Model3

#regression to predict gill/gut/gonad tissue mass from shell length
mod3<-lm(Dissected_gonad_dry_weight ~ Shell_L, data = regressionsub)
summary(mod3)
attributes(mod3)

#add the line
abregplot3<- plot(regressionsub$Shell_L, regressionsub$Dissected_ab_gonad_dry_weight, main = "regression",
     xlab = "Shell Length", ylab = "Gill/gut/gonad complex Dry Tissue",
     pch = 19, frame = FALSE) +
abline(lm(regressionsub$Dissected_ab_gonad_dry_weight ~ regressionsub$Shell_L)) 
#Model 3: gill/gut/gonad complex dry tissue        Formula y= 0.049014x -1.990739

#model 4

#regression to predict soft tissue mass from shell length
mod4<-lm(Dissected_tissue_dry_weight ~ Shell_L, data = regressionsub)
summary(mod4)
attributes(mod4)

#add the line
abregplot4<- plot(regressionsub$Shell_L, regressionsub$Dissected_tissue_dry_weight, main = "regression",
     xlab = "Shell Length", ylab = "Total soft tissue",
     pch = 19, frame = FALSE) +
abline(lm(regressionsub$Dissected_tissue_dry_weight ~ regressionsub$Shell_L)) 
#Model 4: total soft dry tissue        Formula y= 0.15829x -6.63491

#model 5
#regression to predict shell mass from shell length
mod5<-lm(Dissected_shell_dry_weight ~ Shell_L, data = regressionsub)
summary(mod5)
attributes(mod5)

#add the line
abregplot5<- plot(regressionsub$Shell_L, regressionsub$Dissected_shell_dry_weight, main = "regression",
     xlab = "Shell Length", ylab = "Total soft tissue",
     pch = 19, frame = FALSE) +
abline(lm(regressionsub$Dissected_shell_dry_weight ~ regressionsub$Shell_L)) 
#Model 5: shell dry mass        Formula y= 0.40234x -15.78220

#graph estimated total dry mass
ggplot(redabaloneperformance, aes(x=diet, y=est_total_dry_mass_i , fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("Dry Mass (g)") + ggtitle("H. rufescens initial dry mass") + theme(plot.title =element_text(hjust = 0.5))

```

###Abalone Analysis
``` {r}

#remove starved treatment
abmodels<-subset(redabaloneperformance, !diet== "starved")
view(abmodels)

#look at the data without starved treatment
#histogram
ggplot(abmodels, aes(x=terminal_total_dry_mass)) + geom_histogram(binwidth=01)
#when combined, the terminal dry masses show a left leaning distribution
 

# Build the linear model to test normality of residuals
# The model will look at 
model <- lm(terminal_total_dry_mass ~ diet + est_total_dry_mass_i , data = abmodels)
# Create a QQ plot of residuals
ggqqplot(residuals(model))
#there is a slight upward deviations from the expected line in the upward direction on both ends and droops in the middle, however, all points center around the line
par(mfrow = c(2, 2))
plot(model)
#the data look fairly normal

#testing normality with a Shapiro-Wilk test
shapiro_test(residuals(model))
#SW test fails to reject the Ho(p=0.594), the residuals are normally distributed

#Since the data are not normal, we can't use a Bartlette test for equal variance, instead we will use a Levene Test
bartlett.test(terminal_total_dry_mass ~ diet, data=abmodels)
#Levene test fails to reject the null Ho (p-value =0.3937), thus we accept the hypothesis that our variances are equal


#Assumptions for ANCOVA are met, we can now run the analysis to answer the question:
## Does diet type influence abalone weight when initial weight is taken into consideration?"
## H0: there is no difference in abalone weights between diets
## HA: there is a difference in abalone weights between diets

ancova_model <- lm(terminal_dry_tissue_mass ~ diet + est_total_dry_mass_i, data = abmodels)
ancova_model$coeff
Anova(ancova_model, type="III")

#We reject the null hypothesis (p= 0.000775) and embrace the alternative, abalone weights differ between diets


#conduct Tukeys post hoc test to see how the treatments differ
redab.aov.HSD1 <- HSD.test(ancova_model, trt = 'diet') 
print(redab.aov.HSD1)
plot(redab.aov.HSD1)
#all treatments differ from each other

par(mfrow = c(2,2))
plot(ancova_model)


```


## Tegula
###Exploring Data
```{r}
#subset data for tegula
tegulaperformance<-subset(performance, grazer_spp.== "tegula")

#histogram
ggplot(tegulaperformance, aes(x=terminal_dry_tissue_mass)) + geom_histogram()
#the data look fairly normal when combined

##we will conduct ANOVA or GLMM if assumptions are met. Starved treatment is used as a control and to detect if any food treatment is worse than starvation (e.g., toxic and harmful algae), thus, starved treatments will not be used unless a food treatment causes more mass loss than starved. 

#explore the data 

#make boxplot for initial wet mass
ggplot(tegulaperformance, aes(x=diet, y=wetmass_i , fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("T. funebralis Wet Mass (g)") + ggtitle("T. funebralis initial wet mass") + theme(plot.title =element_text(hjust = 0.5))

#make boxplot of final wet mass
ggplot(tegulaperformance, aes(x=diet, y=wetmass_f , fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("T. funebralis Wet Mass (g)") + ggtitle("T. funebralisfinal wet mass by diet") + theme(plot.title =element_text(hjust = 0.5))

#make boxplot for mass difference
ggplot(tegulaperformance, aes(x=diet, y=wetmass_total_Wd , fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("T. funebralis change in wet Mass (g)") + ggtitle("T. funebralis mass change by diet") + theme(plot.title =element_text(hjust = 0.5))
#aside from the variabilty in weights due to water, starved treatment has a mean below zero while others are above 


#look at DRY mass based on tissue type

#make boxplot of final dry mass
ggplot(tegulaperformance, aes(x=diet, y=terminal_dry_tissue_mass , fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("T. funebralis Dry Mass (g)") + ggtitle("T. funebralis final dry tissue by diet") + theme(plot.title =element_text(hjust = 0.5))

#make boxplot of final shell dry mass by diet
ggplot(tegulaperformance, aes(x=diet, y=terminal_shell_dry_mass , fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("Shell Dry Mass (g)") + ggtitle("T. funebralis shell dry mass by diet") + theme(plot.title =element_text(hjust = 0.5))
```

###Estimating Initial Masses
```{r}
#test if there is a significant difference in initial wet masses using a simple anova
initialmassteg<-aov(tegulaperformance$wetmass_i ~ tegulaperformance$diet)
summary(initialmassteg)
#we fail to reject the null hypothesis (p = 0.687), the treatments are not different

##To reduce variance due to water weight, we estimated initial DRY masses through regression analysis using shell lengths to predict dry weight using a sub-sample of the population before the experiment

#read and rename file
regressions <- read.csv("regressiondata.csv",header=T)
View(regressions)

#subset abalone
tegregressions<-subset(regressions, Species == "Teg")
view(tegregressions)

#explore data
mean(tegregressions$Dissected_total_dry_weight)
sd(tegregressions$Dissected_total_dry_weight)
hist(tegregressions$Dissected_total_dry_weight)
mean(tegregressions$Real_L)
sd(tegregressions$Real_L)
hist(tegregressions$Real_L)

#simple scatterplot and pearson correlation
plot(tegregressions$Dissected_total_dry_weight, tegregressions$Real_L, data = tegregressions, main = "scatterplot")
cor(tegregressions$Dissected_total_dry_weight, tegregressions$Real_L)

#Tegula Model

#Teg Model 1 total dry tissue
tegmod1<-lm(Dissected_total_dry_weight ~ Real_L, data = tegregressions)
summary(tegmod1)
attributes(tegmod1)

#add the line
tegplot1<- plot(tegregressions$Real_L, tegregressions$Dissected_total_dry_weight, main = "regression",
     xlab = "Shell Length", ylab = "Tegula Whole Tissue",
     pch = 19, frame = FALSE) +
abline(lm(tegregressions$Dissected_total_dry_weight ~ tegregressions$Real_L)) 

#Teg Model 1: total dry tissue    Y=  0.12235x -0.60049

#Teg Model 2 soft dry tissue
tegmod2<-lm(Dissected_tissue_dry_weight ~ Real_L, data = tegregressions)
summary(tegmod2)
attributes(tegmod2)

#add the line
tegplot2<- plot(tegregressions$Real_L, tegregressions$Dissected_tissue_dry_weight, main = "regression",
     xlab = "Shell Length", ylab = "Tegula Soft Tissue",
     pch = 19, frame = FALSE) +
abline(lm(tegregressions$Dissected_tissue_dry_weight ~ tegregressions$Real_L)) 

#Model 2: soft tissue dry tissue    Y=  0.004463x -0.014478

#Model 3 dry shell
tegmod3<-lm(Dissected_shell_dry_weight ~ Real_L, data = tegregressions)
summary(tegmod3)
attributes(tegmod3)

#add the line
tegplot3<- plot(tegregressions$Real_L, tegregressions$Dissected_shell_dry_weight, main = "regression",
     xlab = "Shell Length", ylab = "Tegula Shell ",
     pch = 19, frame = FALSE) +
abline(lm(tegregressions$Dissected_shell_dry_weight ~ tegregressions$Real_L)) 

#Teg Model 3: total dry tissue    Y=  0.117889x -0.586016

#graph estimated total dry mass
ggplot(tegulaperformance, aes(x=diet, y=est_total_dry_mass_i , fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("Dry Mass (g)") + ggtitle("T.funebralis initial dry mass") + theme(plot.title =element_text(hjust = 0.5))

```

###Tegula Analysis
```{r}


#remove starved treatment
tegmodels<-subset(tegulaperformance, !diet== "starved")
view(tegmodels)

#look at the data without starved treatment
#histogram
ggplot(tegmodels, aes(x=terminal_total_dry_mass)) + geom_histogram(binwidth=0.01)
#when combined, the terminal dry masses show a left leaning distribution
 

# Build the linear model to test normality of residuals
# The model will look at 
Tegmodel <- lm(terminal_total_dry_mass ~ diet + est_total_dry_mass_i , data = tegmodels)
# Create a QQ plot of residuals
ggqqplot(residuals(Tegmodel))
#the data look normal but deviate toward the right end of the QQ plot. May need to address outliers

par(mfrow = c(2, 2))
plot(Tegmodel)
#the data look fairly normalz

#Since the data are not normal, we can't use a Bartlette test for equal variance, instead we will use a Levene Test
bartlett.test(terminal_total_dry_mass ~ diet , data=tegmodels)
#Levene test fails to reject the null Ho (p-value =0.8136), thus we accept the hypothesis that our variances are equal

#run anova with covariate
Anova(Tegmodel, type = "III")

#conduct Tukeys post hoc test to see how the treatments differ
teg.aov.HSD1 <- HSD.test(Tegmodel, trt = 'diet') 
print(teg.aov.HSD1)
plot(teg.aov.HSD1)
#all treatments differ from each other
```



##Righting times
```{r}
performance<-read.csv("PerformanceAssays2020.csv", header=TRUE)
view(performance)
na.omit(performance)

#subset the abalone 
abperf<-subset(performance, grazer_spp.== "red abalone")

#wrangle data to show attempt 1 and attempt 2 side by side for each treatment
gathered_obs<-gather(abperf, key="righting", value="time", 24:25)
view(gathered_obs)
na.omit(gathered_obs)
is.factor(gathered_obs$righting)
as.factor(gathered_obs$righting)

#make bargraph
ggplot(gathered_obs, aes(x=diet, y=time, fill= righting)) + xlab("") + ylab("Time (sec)") + ggtitle("Righting Time Before and After Diet Treatment") + theme(axis.text=element_text(size=12)) + geom_bar(stat="identity",position=position_dodge()) + theme_minimal() +  
  scale_x_discrete(limits = c("starved", "macro", "mixed", "sargassum"), labels=c("starved" = "Starved", "macro" = "M. pyrifera","mixed" = "Mixed","sargassum" = "S. horneri")) +
   geom_vline(xintercept=c(1.5),linetype="dotted") +
  scale_fill_manual("",  values = c("righting_time_1" = "#1260AB", "righting_time_2" = "#009BFF"), labels=c("righting_time_1" = "Initial", "righting_time_2" = "Final")) 
#Overall, initial righting time was higher for starved treatment individuals followed by M. pyrifera, Mixed and S. horneri
##Final righting time increased for starved individuals, mixed, and S. horneri but decreased for M. pyrifera. 



```

#Wrack Dependent Community Assay
```{r}
community<-read.csv("Comm grazer exp.csv", header = T)
view(community )

#explore data

#lets look at TOTAL consumption to see how that differs between treatments
ggplot(community, aes(x= Wrack_treatment , y= Total_Algae_Consumed)) + theme_bw() + geom_boxplot() + ggtitle("Total Algae Consumed") + ylab("Total Consumption(g)") + xlab("Wrack treatment") + theme(plot.title =element_text(hjust = 0.5))
#Overall, the combined consumption of native benthic seaweeds + wrack appears to be lower in the S. horneri treatment


#lets look at how NATIVE BENTHIC SEAWEED consumption differs between treatments
ggplot(community, aes(x= Wrack_treatment , y= Total_Benthic_Algae_Consumed )) + theme_bw() + geom_boxplot() + ggtitle("Total Native Benthic Seaweed Consumed by Wrack Treatment") + ylab("Total Consumption(g)") + xlab("Wrack treatment") + theme(plot.title =element_text(hjust = 0.5))
#The  total biomass of native benthic seaweeds consumed appears to be higher in S. horneri treatment. Suggesting that consumption may have shifted onto NBS when S. horneri was introduced.

#Now lets look at how consumption of just the WRACK species differs by Treatment
ggplot(community, aes(x= Wrack_treatment , y= Total_Wrack_Algae_Consumed )) + theme_bw() + geom_boxplot() + ggtitle("Total Wrack Consumed by Wrack Treatment") + ylab("Total Consumption(g)") + xlab("Wrack treatment") + theme(plot.title =element_text(hjust = 0.5))
#consumption of S. horneri appears to be much lower than consumption of M. pyrifera 




```

#Figures for Manuscript
```{r}
#choice
par(mfrow=c(2,2))
abplot
tegplot
pachyplot
pagurusplot

LabAssayWholeTissue <- read.csv("LabAssaysWholeTissue.csv",header=T)
View(LabAssayWholeTissue)
choice <- LabAssayWholeTissue[1:232,]

fig1<- ggplot(choice, aes(x=algae_spp., y= algae_Wd, fill = algae_spp.)) + geom_boxplot(show.legend = FALSE) + theme_bw()  + xlab("") + ylab("Algae Mass Consumed (g)") + ggtitle("Food Choice Assay") + theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),plot.title =element_text(hjust = 0.5)) + 
  facet_grid(grazer_spp. ~., scales = "free_y", labeller = as_labeller(c("Haliotis cracherodii" = "H. cracherodii", "Tegula" = "T. funebralis", "Pachy" = "P. crassipes", "Pagurus" = "P. samuelis")),)

fig1

view(choice)

#performance
#this figure only shows final dry mass of non-shell tissue for tegula and red abalone. All other tissue will be in the appendix

fig2<- ggplot(performance, aes(x=diet, y= terminal_dry_tissue_mass, fill= diet)) + 
  geom_boxplot(show.legend = FALSE) + theme_bw() + 
  xlab("Diet") + 
  ylab("Dry Tissue Mass (g)") + 
  ggtitle("Herbivore Dry Tissue Mass by Diet") + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12), plot.title =element_text(hjust = 0.5)) +
  facet_grid(grazer_spp. ~ ., scales = "free_y", labeller = as_labeller(c("red abalone" = "H. rufescence", "tegula" = "T. funebralis"))) +
  scale_x_discrete(limits = c("starved", "macro", "mixed", "sargassum"), labels=c("starved" = "Starved", "macro" = "M. pyrifera",
                              "mixed" = "Mixed","sargassum" = "S. horneri")) +
   geom_vline(xintercept=c(1.5),linetype="dotted") +
   theme(axis.text.x = element_text(face="italic", 
                           size=10))
fig2
```

