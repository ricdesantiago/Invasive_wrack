---
title: "Invasive_wrack_manuscript_code"
author: "Ric DeSantiago"
date: "12/15/2021"
output: html_document
---
#libraries
```{r libraries}
library(knitr)
library(tidyverse)
library(tidyr)
library(ggplot2)
library(ggfortify)
library(lme4)
library(car)
library(nlme)
library(ggpubr)
library(multcompView)
library(boot)
library(Hotelling)
library(mvnTest)
library(vegan)
library(factoextra)
library(FactoMineR)
library(agricolae)
library(glmm)
library(HH)
library(ggpubr)
library(rstatix)
#hi
```


#Field Surveys
```{r}

wrack<-read.csv("InvasiveWrackSurveySNIJan2020.csv", header = TRUE)
view(wrack)
Grazer_Survey_Data <- read.csv("GrzrOnOffSurveySNIJan2020.csv") 
view(Grazer_Survey_Data)

```

#Wrack surveys
```{r}
#make a new column in datasheet for the proportion of total wrack patty area made up of sargassum
wrack$propsarg <- wrack$sarg_total / wrack$ellipse_A_m2

#make new column to show proportion of total made up of macrocystis (1-sargassum)
wrack$propmac<- 1 - wrack$propsarg

#make graph to show these proportions
ggplot(data=wrack, aes(x=site, y=propmac, fill=propsarg)) +
  geom_bar(stat="identity")

```

#Invasive Wrack usage survey
```{r}
Grazer_Survey_Data <- read.csv("GrzrOnOffSurveySNIJan2020.csv") 

#we want to remove any row that has double 0's, so a 0 for on and a 0 for off, this is because not every recorder recorded 0's when animals weren't seen. Therefore, by keeping double 0's in, we're inflating the likelihood of not finding an animal

Grazer_Survey_Data_edited <- Grazer_Survey_Data 
Grazer_Survey_Data_edited<- mutate(Grazer_Survey_Data_edited, Grazer_sum = on_wrack + off_wrack) 
filter(Grazer_Survey_Data_edited, Grazer_sum != 0)
#this removed 13 observations

#create a dataframe with just important columns
Grazer_Survey_Data_reduced <- na.omit(Grazer_Survey_Data_edited[, -c(1:3, 5, 7)])

#Change to long format
Grazer_Survey_Data_long <- gather(data = Grazer_Survey_Data_reduced, 
                                 key = "Wrack.Use", value = "Grazer_sum", c(on_wrack, off_wrack), factor_key = TRUE)

#Barplot
barplot<- ggplot(Grazer_Survey_Data_long, aes(fill=Wrack.Use, y=Grazer_sum, x=grzr_sp)) + 
    geom_bar(position="dodge", stat="identity")

barplot


pdf(file = "On.off_grazersurvey_Jan2020SanNic.pdf", width = 6, height = 4, useDingbats=F)

Plot_Bar_g <- ggplot(data=meanAbundance_grazer,
                      aes(y=mean_Abundance, 
                          x=grzr_sp, 
                          fill = Wrack.Use)) +
  geom_bar(stat = "identity", colour = "black", 
           position = position_dodge(width = 0.9))

Plot_Bar_g + theme(axis.title.x = element_text(face="bold",
                                                 size=22),
                           axis.text.x  = element_text(size=20)) + 
  xlab("Grazer") +
  theme(axis.title.y = element_blank()) + 
  ylab("Count (max 20)") +
  theme(axis.title.y = element_text(angle=90, 
                                    face="bold", 
                                    size=22, 
                                    vjust=1.5),
        axis.text.y  = element_text(size=20)) +
  geom_errorbar(aes(ymin=mean_Abundance - SE, 
                    ymax=mean_Abundance + SE), width = 0.05,
                position=position_dodge(width = 0.9)) +
  scale_fill_manual(name = "Wrack usage",
                    values = c("#999999", "#009E73")) +
  theme(legend.justification=c(.5,.5), legend.position=c(.18,.88)) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0)),
                     breaks = pretty(c(0,20), n = 5), 
                     limits = c(0,20))

dev.off()

#let's extract the sample sizes for each of the grazers bc we didn't see grazers everytime

Grazer_Survey_Data_reduced %>% 
  count(grzr_sp)

```


#Initial weight estimates
```{r }
#read and rename file
regressions <- read.csv("regressiondata.csv",header=T)
View(regressions)

#subset abalone
regressionsub<-subset(regressions, Species == "Ab")

#subset tegula
regressiontegsub<-subset(regressions, Species == "Teg")
view(regressiontegsub)

```

## Abalone Models
```{r }

#explore data
mean(regressionsub$Dissected_sum_drytissue)
sd(regressionsub$Dissected_sum_drytissue)
hist(regressionsub$Dissected_sum_drytissue)
mean(regressionsub$Shell_L)
sd(regressionsub$Shell_L)
hist(regressionsub$Shell_L)

#simple scatterplot and pearson correlation
plot(regressionsub$Dissected_sum_drytissue, regressionsub$Shell_L, data = regressionsub, main = "scatterplot")
cor(regressionsub$Dissected_sum_drytissue, regressionsub$Shell_L)


#Abalone models 
#model 1
#regression to predict dry tissue
mod<-lm(Dissected_sum_drytissue ~ Shell_L, data = regressionsub)
summary(mod)
attributes(mod)

#add the line
abregplot<- plot(regressionsub$Shell_L, regressionsub$Dissected_ab_gonad_dry_weight, main = "regression",
     xlab = "Shell Length", ylab = "Total Dry Tissue",
     pch = 19, frame = FALSE) +
abline(lm(regressionsub$Dissected_ab_gonad_dry_weight ~ regressionsub$Shell_L)) 


#model 2

#regression to predict body dry tissue
mod2<-lm(Dissected_ab_nongonad_dry_weight ~ Shell_L, data = regressionsub)
summary(mod2)
attributes(mod2)

#add the line
abregplot2<- plot(regressionsub$Shell_L, regressionsub$Dissected_ab_nongonad_dry_weight, main = "regression",
     xlab = "Shell Length", ylab = "Foot Dry Tissue",
     pch = 19, frame = FALSE) +
abline(lm(regressionsub$Dissected_ab_nongonad_dry_weight ~ regressionsub$Shell_L)) 


#Model3

#regression to predict gill/gut/gonad tissue
mod3<-lm(Dissected_ab_gonad_dry_weight ~ Shell_L, data = regressionsub)
summary(mod3)
attributes(mod3)

#add the line
abregplot3<- plot(regressionsub$Shell_L, regressionsub$Dissected_ab_gonad_dry_weight, main = "regression",
     xlab = "Shell Length", ylab = "Gill/gut/gonad complex Dry Tissue",
     pch = 19, frame = FALSE) +
abline(lm(regressionsub$Dissected_ab_gonad_dry_weight ~ regressionsub$Shell_L)) 

```


## Tegula Models
```{r }
#Tegula Model

#explore data
mean(regressiontegsub$Dissected_sum_drytissue)
sd(regressiontegsub$Dissected_sum_drytissue)
hist(regressiontegsub$Dissected_sum_drytissue)

#model4 dry tegula tissue
mod4<-lm(Dissected_sum_drytissue ~ Real_L, data = regressiontegsub)
summary(mod4)
attributes(mod4)

#add the line
abregplot4<- plot(regressiontegsub$Real_L, regressiontegsub$Dissected_sum_drytissue, main = "regression",
     xlab = "Shell Length", ylab = "Tegula Whole Tissue",
     pch = 19, frame = FALSE) +
abline(lm(regressiontegsub$Dissected_sum_drytissue ~ regressiontegsub$Real_L)) 

 
```

#Performance Assays March-April 2020
```{r}
#load data
performance<-read.csv("PerformanceAssays2020.csv", header=TRUE)
view(performance)
na.omit(performance)

is.numeric(performance$wetmass_total_Wd)
performance$wetmass_total_Wd<-as.numeric(performance$wetmass_total_Wd)
is.factor(performance$treatment)
performance$treatment<-as.factor(performance$treatment)

#create new column to look at weight difference (Wf-Wi) as a percent of initial weight (Wd/Wi *100)
performance<-mutate(performance, percent_change = performance$wetmass_total_Wd / performance$wetmass_i* 100)
view(performance)


```

## Tegula
```{r}

#subset data for tegula
tegulaperformance<-subset(performance, grazer_spp.== "tegula")

#histogram
ggplot(tegulaperformance, aes(x=terminal_dry_mass)) + geom_histogram()

#make boxplot of percent change by diet
ggplot(tegulaperformance, aes(x= diet , y= percent_change, fill = diet )) + theme_bw() + geom_boxplot() + ggtitle("T. funebralis percent change in total mass") + ylab("Total mass change (%)") + xlab("Diet Treatment") + guides(fill= F) + theme(plot.title =element_text(hjust = 0.5))


#make boxplot of final tissue dry mass by diet
ggplot(tegulaperformance, aes(x=diet, y=terminal_dry_mass, fill= treatment)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("Tissue Dry Mass (g)") + ggtitle("Tegula final dry mass by diet") + theme(plot.title =element_text(hjust = 0.5))


#make boxplot of final shell dry mass by diet
ggplot(tegulaperformance, aes(x=diet, y=terminal_shell_dry_mass , fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("Shell Dry Mass (g)") + ggtitle("Tegula final shell dry mass by diet") + theme(plot.title =element_text(hjust = 0.5))


#run analysis of variance using aov function
tegaov<- aov(tegulaperformance$percent_change ~ tegulaperformance$diet)
#view aov stats
summary(tegaov)

#check assumptions of ANOVA
# check Levene's test for constant variance
leveneTest(tegaov)
## null hypothesis is that we have constant variance
### P=0.55, do not reject the hypothesis

#check the normality of the residuals
qqnorm(tegaov$residuals)
shapiro.test(tegaov$residuals)
##resuduals are normally distributed

#Tukeys post hoc test
teg.aov.HSD <- HSD.test(tegaov, trt = 'tegulaperformance$diet') 
print(teg.aov.HSD)
plot(teg.aov.HSD)

```



##Red Abalone
```{r}

#subset data for tegula
redabaloneperformance<-subset(performance, grazer_spp.== "red abalone")
view(redabaloneperformance)
#histogram
ggplot(redabaloneperformance, aes(x=redabaloneperformance$percent_change)) + geom_histogram(binwidth=5)

#make boxplot of percent change in wetmass by diet
ggplot(redabaloneperformance, aes(x= diet , y= percent_change, fill = diet )) + theme_bw() + geom_boxplot() + ggtitle("H. rufescens percent change in total mass") + ylab("Total mass change (%)") + xlab("Diet Treatment") + guides(fill= F) + theme(plot.title =element_text(hjust = 0.5))

#make boxplot of final tissue dry mass by diet
ggplot(redabaloneperformance, aes(x=diet, y=terminal_dry_mass, fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("Tissue Dry Mass (g)") + ggtitle("H. rufescens final dry mass by diet") + theme(plot.title =element_text(hjust = 0.5))

#make boxplot of final gonad dry mass by diet
ggplot(redabaloneperformance, aes(x=diet, y=gonad_dry_mass, fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("Gonad Dry Mass (g)") + ggtitle("H. rufescens final gonad dry mass by diet") + theme(plot.title =element_text(hjust = 0.5))

#make boxplot of final nongonad dry mass by diet
ggplot(redabaloneperformance, aes(x=diet, y=nongonad_dry_mass, fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("Tissue Dry Mass (g)") + ggtitle("H. rufescens final non-gonad dry mass by diet") + theme(plot.title =element_text(hjust = 0.5))

#make boxplot of final shell dry mass by diet
ggplot(redabaloneperformance, aes(x=diet, y=terminal_shell_dry_mass , fill= diet)) + geom_boxplot() + theme_bw()   + xlab("Diet") + ylab("Shell Dry Mass (g)") + ggtitle("H. rufescens final shell dry mass by diet") + theme(plot.title =element_text(hjust = 0.5))


# Build the linear model to test normality
model  <- lm(terminal_dry_mass ~ diet, data = redabaloneperformance)
# Create a QQ plot of residuals
ggqqplot(residuals(model))
#there is a slight U shaped pattern in the data where the distribution deviates from the expected line in the upward direction on both ends and droops in the middle

#testing normality with a Shapiro-Wilk test
shapiro_test(residuals(model))
#SW test rejects the Ho(p=0.01308574), thus we accept the alternative H that the data are not normally distributed.

#Since the data are not normal, we can't use a Barlette test for equal variance, instead we will use a Levene Test
leveneTest(terminal_dry_mass~diet, data=redabaloneperformance)
#Levene test fails to reject the null Ho (p-value = 0.07774), thus we accept the hypothesis that our variances are equal

#general linear model will not work for our data if we were just looking at the impact of diet on abalone mass, however, we want to account for starting differences in weight.
##because our initial weights were in wet mass, they will be higher in total value and introduce more variablity due to water weight, thus, we cannot use those values
###We will account for initial weights of animals by estimating initial dry mass using shell length to predict dry mass as calculated using our intial sample's above in "initial weight estimates"
####We calculated these numbers using a linear regression and then input the estimated initial values into the original datasheet "PerformanceAssay2020.csv"

#To remind us of the question we want to ask "does diet impact abalone weight?"
##We think that diet will cause differences in weight, however, we know that initial weight matters and individual growth rates matter.
###However, we are not interested in how individual abalone grow relative to each other, regardless, we need to account for the variation introduced by this.
####We also know that starting weight matters, as many animals grow more rapidly when young and asymptote as they grow, etc.
######Thus we can account for this variation with a generalised linear model

testing <- glm(terminal_dry_mass ~ treatment + (1|est_total_dry_mass_i),
                family=gaussian, data=redabaloneperformance)
summary(testing)


ancova_model <- aov(terminal_dry_mass ~ diet , data = redabaloneperformance)
Anova(ancova_model, type="III")

redab.aov.HSD1 <- HSD.test(ancova_model, trt = 'diet') 
print(redab.aov.HSD1)
plot(redab.aov.HSD1)

redab.ancova.HSD<-ancova()




#Tukeys post hoc test
redab.aov.HSD <- HSD.test(redabaov, trt = 'redabaloneperformance$diet') 
print(redab.aov.HSD)
plot(redab.aov.HSD)




```

##Righting times
```{r}
performance<-read.csv("PerformanceAssays2020.csv", header=TRUE)
view(performance)
na.omit(performance)

#subset the abalone 
abperf<-subset(performance, grazer_spp.== "red abalone")

#wrangle data to show attempt 1 and attempt 2 side by side for each treatment
gathered_obs<-gather(abperf, key="righting", value="time", 24:25)
view(gathered_obs)
na.omit(gathered_obs)
is.factor(gathered_obs$righting)
as.factor(gathered_obs$righting)

#make boxplot
ggplot(gathered_obs, aes(x= diet , y= time, fill = righting )) + theme_bw() + geom_boxplot()


ggplot(gathered_obs, aes(x=diet, y=time, fill= righting)) +
  geom_bar(stat="identity",position=position_dodge())+theme_minimal()

```
